# {{ ansible_managed }}

global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    user haproxy
    group haproxy
    daemon

defaults
    log global
    mode http
    option httplog
    option dontlog null
    option forwardfor
    option http-server-close
    timeout connect 5000
    timeout client  50000
    timeout server  50000

# Application routing
listen http
    bind {{ balancer.floating_ip }}:{{ balancer.http.port }}
    balance leastconn
{% for server in groups['webservers'] %}
    server {{ server }} {{ hostvars[server].ansible_host }}:80 check
{% endfor %}

# Database routing
listen db
    bind {{ balancer.floating_ip }}:{{ balancer.db.port }}
    mode tcp
    balance leastconn
    stick-table type ip size 255 expire 30m

{% for server in groups['nodes'] %}
    server {{ server }} {{ hostvars[server].ansible_host }}:8888 check
{% endfor %}
